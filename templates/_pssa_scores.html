<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="{{ STATIC_URL }}/js/canvasjs.js"></script>
<style type="text/css">
  .scores-container {
    height: 200px;
    width: 300px;
  }
</style>
<script type="text/javascript">
var app = app || {};

app.getChartData = function(school_pk, grade) {
  $.when(
    $.ajax({
      url: '/api/v1/school_curricula/' + {{ school.pk }} + '/?format=json&grade=' + {{ current_grade }},
    }),
    $.ajax({
      url: '{{ STATIC_URL }}/data/pssa.json'
    })
  ).then(function(schoolInfo, districtInfo) {
    var schoolScores = app.formatPSSASchoolData(JSON.parse(schoolInfo[0].curriculum.pssa_test_scores));
    var districtScores = districtInfo[0][{{ current_grade }}];

    app.createChartv2(schoolScores, districtScores, 'read', 'reading-scores');
    app.createChartv2(schoolScores, districtScores, 'math', 'math-scores');
  });
}

app.getChartData();

app.formatPSSASchoolData = function(scores) {
  var fScores = {
    "read": [],
    "math": []
  };

  for(var i=0; i<scores.length; i++) {
    fScores.read.push(scores[i].read_combined_percent);
    fScores.math.push(scores[i].math_combined_percent);
  }

  return fScores;
};

app.createChartv2 = function(schoolScores, districtScores, subject, container) {
  console.log(schoolScores);
  
  var chart = new CanvasJS.Chart(container, {  
    title: {
      text: "PSSA " + subject + " combined percent scores",
      fontSize: 12
    },
    theme: "theme2",
    axisX: {
      // we are cheating here and using the month value as the
      // second part of the school year in the x label
      valueFormatString: "YYYY-MM",
      lineThickness: 0,
      labelFontSize: 0,
      tickThickness: 0,
      tickLength: 0
    },
    axisY: {
      valueFormatString: "#'%'"
    },
    toolTip: {
      shared: true
    },
    data: [
      {
        type: "line",
        lineThickness: 2,
        name: "District",
        dataPoints: [
          {x: new Date(2008,08,1), y: districtScores[subject][0]},
          {x: new Date(2009,09,1), y: districtScores[subject][1]},
          {x: new Date(2010,10,1), y: districtScores[subject][2]},
          {x: new Date(2011,11,1), y: districtScores[subject][3]}
        ]
      },
      {
        type: "line",
        lineThickness: 2,
        name: "School",
        dataPoints: [
          {x: new Date(2008,08,01), y: schoolScores[subject][0]},
          {x: new Date(2009,09,01), y: schoolScores[subject][1]},
          {x: new Date(2010,10,01), y: schoolScores[subject][2]},
          {x: new Date(2011,11,01), y: schoolScores[subject][3]},
        ]
      }
    ]
  });

  chart.render();
};
</script>
